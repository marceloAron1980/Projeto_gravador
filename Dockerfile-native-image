# Etapa 1 - Build do JAR
FROM --platform=linux/amd64 maven:3.9.6-eclipse-temurin-21 as builder
WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN mvn clean package -DskipTests

# Etapa 2 - GraalVM ARM64 com native-image
FROM --platform=linux/arm64 ubuntu:24.04 as graalvm
WORKDIR /app

# Instalar dependências para o native-image
RUN apt-get update && apt-get install -y \
    build-essential zlib1g-dev curl unzip \
    && rm -rf /var/lib/apt/lists/*

# Instalar o GraalVM manualmente
COPY graalvm-community-jdk-21.0.2_linux-aarch64_bin.tar.gz /tmp/
RUN mkdir -p /opt/graalvm && \
    tar -xzf /tmp/graalvm-community-jdk-21.0.2_linux-aarch64_bin.tar.gz --strip-components=1 -C /opt/graalvm
ENV JAVA_HOME="/opt/graalvm"
ENV PATH="$JAVA_HOME/bin:$PATH"

# Copiar arquivos do build
COPY --from=builder /app/target/*.jar app.jar
COPY config-example.json .
COPY sr_channels.conf .

# Gerar o executável nativo com o GraalVM
RUN native-image \
    --no-fallback \
    -H:+UnlockExperimentalVMOptions \
    -H:Name=app-arm64 \
    -H:IncludeResources='config-example.json|sr_channels.conf' \
    -cp app.jar br.com.spotcom.gravador.Main

# Etapa 3 - Imagem final otimizada e leve
FROM --platform=linux/arm64 ubuntu:24.04
WORKDIR /app
COPY --from=graalvm /app/app-arm64 .
COPY config-example.json .
COPY sr_channels.conf .
RUN chmod +x /app/app-arm64
ENTRYPOINT ["/app/app-arm64"]

